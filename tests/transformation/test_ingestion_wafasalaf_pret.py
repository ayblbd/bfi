import pandas as pd

from src.transformation.ingestion_wafasalaf_pret import build_wafasalaf_pret
from tests.conftest import compare_dataframes


def test_build_wafasalaf_pret(spark):
    df = spark.createDataFrame(
        [
            (
                "AIT SI ALI                      LAHOUSSAINE                     CNBJ55727   0522625980DARLAMANEBLOKCKIMM257APT5CASABLANCA                                                             MAD021780000005000119443153C70006312144         2G000250000000000000000132007101620071205 0520071016000000200710160000002007101600000020071016013200000013200000WAFAA00000100000000040000000000400000000000000000        00000000000003252420200812050000067317KOUTAIBIMohammed                                            3436130       PREL      20070701    20081204                    MEGAFRO                                           N    000000000000000440.000000000000000000000.000000000000000007082.370                    CreditSariiBanqueTR/11D:0                                                                           000000000000019467.970000000000000000000.000000000000000000000.000000000000000025000.000000000000000000000.000000000000000025000.000PP     0PLATE FORME SIEGE                                                                                   000000000000003000.000RA        MRAISS                        000000000000000100.000          000000000000000000.000021780000005000119443153",
            ),
        ],
        ["value"],
    )

    actual = build_wafasalaf_pret(df, "2024-10-10")
    expected = pd.DataFrame(
        [
            (
                "2024-10-10",
                "050",
                "05000119443",
                "06312144",
                "7000",
                25000.0,
                0.0,
                "2007-10-16",
                "2008-11-16",
                13,
                673.17,
                13.2,
                0,
                "ACCORDE",
                "G",
                "CdmS@rii",
                "AIT SI ALI",
                "LAHOUSSAINE",
                "CN",
                "BJ55727",
                "0522625980",
                "DARLAMANEBLOKCKIMM257APT5CASABLANCA",
                "2",
                5,
                None,
                "2007-10-16",
                "2007-10-16",
                "2007-10-16",
                "2007-10-16",
                0.0,
                0.0,
                32524.2,
                "KOUTAIBIMohammed",
                "2007-10-16",
                "cdm-u3436",
                "130",
                "PREL",
                "2007-07-01",
                "2008-12-04",
                None,
                None,
                "MEGAFRO",
                "N",
                440.0,
                0.0,
                7082.37,
                "",
                "",
                "CreditSariiBanqueTR/11D:0",
                19467.97,
                0.0,
                0.0,
                25000.0,
                0.0,
                25000.0,
                "PP",
                "0",
                "PLATE FORME SIEGE",
                3000.0,
                "RA",
                "MRAISS",
                100.0,
                "",
                0.0,
                "MAD",
                "021780000005000119443153",
                "C",
                "2007-12-05",
                "WAFAA",
                100.0,
                400.0,
                40.0,
                "021780000005000119443153",
            ),
        ],
        columns=[
            "partitiondate",
            "code_agence",
            "numerodecompte",
            "numerodeprets",
            "categoriedeprets",
            "nominal",
            "restdu",
            "datedeblocage",
            "dateecheance",
            "duree",
            "montantecheance",
            "taux",
            "nombreimpaye",
            "situationpret",
            "etat",
            "lieutraitement",
            "nomemprunteur",
            "prenomemprunteur",
            "typeidentite",
            "numidentite",
            "numtelephone",
            "adresse",
            "doti",
            "numjourech",
            "dt_premechimp",
            "dt_proposition",
            "dt_accord",
            "dt_dernmodif",
            "dt_signature",
            "mnt_globimpay",
            "mnt_interretard",
            "mnt_interpenalite",
            "initiateur",
            "datesaisie",
            "matricule",
            "code_age_app",
            "code_regl",
            "date_cpt_cli",
            "date_ctx",
            "date_ech_imp",
            "date_rpat",
            "nom_cli_empl",
            "forcage",
            "frais_dos_ttc",
            "frais_imm",
            "frais_recouv",
            "heure_accord",
            "heure_debloc",
            "libelle_bar",
            "mt_crd_ctx",
            "mt_int_diff",
            "mt_cred_autre",
            "mt_cred_brut",
            "mt_rpat",
            "mt_cred_net",
            "nature_credit",
            "nbr_aff_sub",
            "nom_agence",
            "rev_cli",
            "type_ra",
            "user_debl",
            "mt_autre",
            "heure_instr",
            "mt_rees",
            "devise",
            "rib",
            "ind_ctx",
            "ech1",
            "code_org",
            "mtt_assur",
            "mtt_fr_dos",
            "mtt_tva",
            "rib_prelev",
        ],
    )
    expected["date_cpt_cli"] = pd.to_datetime(expected["date_cpt_cli"]).dt.date
    expected["date_ctx"] = pd.to_datetime(expected["date_ctx"]).dt.date
    expected["datedeblocage"] = pd.to_datetime(expected["datedeblocage"]).dt.date
    expected["dateecheance"] = pd.to_datetime(expected["dateecheance"]).dt.date
    expected["dt_premechimp"] = pd.to_datetime(expected["dt_premechimp"]).dt.date
    expected["dt_proposition"] = pd.to_datetime(expected["dt_proposition"]).dt.date
    expected["dt_accord"] = pd.to_datetime(expected["dt_accord"]).dt.date
    expected["dt_dernmodif"] = pd.to_datetime(expected["dt_dernmodif"]).dt.date
    expected["dt_signature"] = pd.to_datetime(expected["dt_signature"]).dt.date
    expected["datesaisie"] = pd.to_datetime(expected["datesaisie"]).dt.date
    expected["date_ech_imp"] = pd.to_datetime(expected["date_ech_imp"]).dt.date
    expected["date_rpat"] = pd.to_datetime(expected["date_rpat"]).dt.date
    expected["ech1"] = pd.to_datetime(expected["ech1"]).dt.date
    expected["partitiondate"] = pd.to_datetime(expected["partitiondate"]).dt.date

    compare_dataframes(actual, expected, sort_by=["nomemprunteur"])
